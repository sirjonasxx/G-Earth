name: Build G-Earth

on:
  push:
    paths:
      - '.github/workflows/**'
      - 'deps/**'
      - 'G-Earth/**'
      - 'pom.xml'

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            jdk-package: 'jdk+fx'
            jdk-arch: 'x86'
            jdk-distribution: 'liberica'
          - os: windows-latest
            jdk-package: 'jdk'
            jdk-arch: 'x64'
            jdk-distribution: 'temurin'
          - os: macos-latest
            jdk-package: 'jdk'
            jdk-arch: 'x64'
            jdk-distribution: 'temurin'
          - os: macos-latest
            jdk-package: 'jdk'
            jdk-arch: 'aarch64'
            jdk-distribution: 'temurin'
          - os: ubuntu-latest
            jdk-package: 'jdk'
            jdk-arch: 'x64'
            jdk-distribution: 'temurin'

    runs-on: ${{ matrix.os }}
    permissions:
      contents: read

    name: Build ${{ matrix.os }} (${{ matrix.jdk-arch }})
    steps:
    - name: Set OS variable
      id: osmap
      shell: bash
      run: |
        if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
          echo "TARGET_OS=windows" >> $GITHUB_ENV
        elif [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
          echo "TARGET_OS=linux" >> $GITHUB_ENV
        elif [[ "${{ matrix.os }}" == "macos-latest" ]]; then
          echo "TARGET_OS=mac" >> $GITHUB_ENV
        fi

    - name: Checkout G-Earth
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        java-package: ${{ matrix.jdk-package }}
        architecture: ${{ matrix.jdk-arch }}
        distribution: ${{ matrix.jdk-distribution }}
        cache: 'maven'
        cache-dependency-path: 'G-Earth/pom.xml'

    - name: Install JavaPackager
      working-directory: deps/JavaPackager
      run: ./gradlew publishToMavenLocal

    # Check if GITHUB_REF_TYPE is a tag
    - name: Build G-Earth
      shell: bash
      env:
        MATRIX_OS: ${{ matrix.os }}
        MATRIX_JDK_ARCH: ${{ matrix.jdk-arch }}
      run: |
        if [[ $MATRIX_OS == "windows-latest" && $MATRIX_JDK_ARCH == "x86" ]]; then
          MVN_PROFILE="-P!include-javafx"
        else
          MVN_PROFILE="-Pinclude-javafx"
        fi
        
        if [[ $GITHUB_REF_TYPE == 'tag' ]]; then
          mvn -B package $MVN_PROFILE \
            -Drepository=${GITHUB_REPOSITORY} \
            -Dmaven.compiler.source=17 \
            -Dmaven.compiler.target=17 \
            -Dos=${TARGET_OS} \
            -Dchangelist=
        else
          mvn -B package $MVN_PROFILE \
            -Drepository=${GITHUB_REPOSITORY} \
            -Dmaven.compiler.source=17 \
            -Dmaven.compiler.target=17 \
            -Dos=${TARGET_OS}
        fi

    - name: Upload platform artifact
      uses: actions/upload-artifact@v4
      with:
        name: G-Earth ${{ env.TARGET_OS }}-${{ matrix.jdk-arch }}
        path: G-Earth/target/G-Earth
        retention-days: 7
