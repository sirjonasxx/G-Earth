name: Build G-Earth

on:
  push:
    paths:
      - '.github/workflows/**'
      - 'deps/**'
      - 'G-Earth/**'
      - 'pom.xml'

jobs:
  build:

    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
    - name: Checkout G-Earth
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        java-package: jdk
        distribution: 'temurin'

    - name: Install JavaPackager
      working-directory: deps/JavaPackager
      run: ./gradlew publishToMavenLocal

    # Check if GITHUB_REF_TYPE is a tag
    - name: Build G-Earth
      run: |
        if [[ $GITHUB_REF_TYPE == 'tag' ]]; then
          mvn -B package -Drepository=${GITHUB_REPOSITORY} -Dchangelist=
        else
          mvn -B package -Drepository=${GITHUB_REPOSITORY}
        fi
        
    - name: Upload Mac OSX
      uses: actions/upload-artifact@v4
      with:
        name: Mac OSX
        path: G-Earth/target/G-Earth-mac.zip
        retention-days: 7

    - name: Upload Linux
      uses: actions/upload-artifact@v4
      with:
        name: Linux
        path: G-Earth/target/G-Earth-linux.zip
        retention-days: 7

    - name: Upload Windows
      uses: actions/upload-artifact@v4
      with:
        name: Windows x32
        path: G-Earth/target/G-Earth-windows.zip
        retention-days: 7
